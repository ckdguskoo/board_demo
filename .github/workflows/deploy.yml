name: Deploy to EC2

on:
  push:
    branches:
      - main
      - master
  workflow_dispatch:

env:
  DOCKER_COMPOSE_VERSION: 2.24.0
  APP_DIR: ${{ secrets.EC2_PATH }}

jobs:
  build-and-deploy:
    name: Build and Deploy to EC2
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'

      - name: Build backend JAR
        working-directory: ./board_backend
        run: |
          chmod +x gradlew
          ./gradlew clean bootJar --no-daemon
          ls -lh build/libs/

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build frontend image
        run: |
          docker buildx build \
            --build-arg NEXT_PUBLIC_API_URL=http://13.124.84.86:8080 \
            --no-cache \
            --file ./board_frontend/Dockerfile \
            --tag board-frontend:latest \
            --output type=docker,dest=/tmp/frontend-image.tar \
            ./board_frontend

      - name: Configure SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.EC2_SSH_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H ${{ secrets.EC2_HOST }} >> ~/.ssh/known_hosts

      - name: Setup EC2 Environment
        run: |
          ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} << EOF
            # Docker ì„¤ì¹˜ í™•ì¸
            if ! command -v docker &> /dev/null; then
              echo "Docker ì„¤ì¹˜ ì¤‘..."
              sudo yum update -y
              sudo yum install -y docker
              sudo systemctl start docker
              sudo systemctl enable docker
              sudo usermod -aG docker $USER
            fi
            
            # Docker Compose ì„¤ì¹˜ í™•ì¸
            if ! command -v docker-compose &> /dev/null; then
              echo "Docker Compose ì„¤ì¹˜ ì¤‘..."
              sudo curl -L "https://github.com/docker/compose/releases/download/v${DOCKER_COMPOSE_VERSION}/docker-compose-\$(uname -s)-\$(uname -m)" -o /usr/local/bin/docker-compose
              sudo chmod +x /usr/local/bin/docker-compose
            fi
            
            # Java ì„¤ì¹˜ í™•ì¸
            if ! command -v java &> /dev/null; then
              echo "Java ì„¤ì¹˜ ì¤‘..."
              sudo yum install -y java-21-amazon-corretto
            fi
            
            # ì•± ë””ë ‰í† ë¦¬ ìƒì„±
            mkdir -p ${APP_DIR}
            mkdir -p ~/board_demo
          EOF

      - name: Deploy JAR file to EC2
        run: |
          # JAR íŒŒì¼ ì°¾ê¸°
          JAR_FILE=$(find board_backend/build/libs -name "*.jar" ! -name "*-plain.jar" | head -n 1)
          
          if [ -z "$JAR_FILE" ]; then
            echo "âŒ JAR íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."
            exit 1
          fi
          
          echo "ğŸ“¦ ë°°í¬í•  JAR íŒŒì¼: $JAR_FILE"
          
          # EC2ë¡œ JAR íŒŒì¼ ì „ì†¡
          scp -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no \
            "$JAR_FILE" \
            ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }}:${APP_DIR}/board-demo.jar
          
          # ì‹¤í–‰ ê¶Œí•œ ë¶€ì—¬
          ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} << EOF
            chmod +x ${APP_DIR}/board-demo.jar
            ls -lh ${APP_DIR}/board-demo.jar
          EOF

      - name: Copy configuration files to EC2
        run: |
          ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} << EOF
            cd ~/board_demo
            
            # Git ì €ì¥ì†Œ ì—…ë°ì´íŠ¸ ë˜ëŠ” í´ë¡ 
            if [ -d .git ]; then
              git fetch origin
              git reset --hard origin/main || git reset --hard origin/master
            else
              git clone ${{ github.server_url }}/${{ github.repository }} .
            fi
          EOF

      - name: Transfer frontend Docker image to EC2
        run: |
          # ì´ë¯¸ì§€ ì••ì¶•
          gzip -c /tmp/frontend-image.tar > /tmp/frontend-image.tar.gz
          
          # EC2ë¡œ ì „ì†¡
          scp -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no \
            /tmp/frontend-image.tar.gz \
            ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }}:~/board_demo/
          
          # EC2ì—ì„œ ì´ë¯¸ì§€ ë¡œë“œ
          ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} << EOF
            cd ~/board_demo
            gunzip -c frontend-image.tar.gz | docker load
            rm -f frontend-image.tar.gz
          EOF

      - name: Deploy with Docker Compose
        run: |
          ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} << EOF
            cd ~/board_demo
            
            # í™˜ê²½ ë³€ìˆ˜ íŒŒì¼ ìƒì„±
            cat > .env << EOL
DB_PASSWORD=${{ secrets.DB_PASSWORD || 'root1234' }}
NEXT_PUBLIC_API_URL=http://${{ secrets.EC2_HOST }}:8080
APP_DIR=${{ secrets.EC2_PATH }}
EOL
            
            # ê¸°ì¡´ ì»¨í…Œì´ë„ˆ ì¤‘ì§€ ë° ì œê±°
            docker-compose down || true
            
            # ì„œë¹„ìŠ¤ ì‹œì‘
            docker-compose up -d --no-build
            
            # ì»¨í…Œì´ë„ˆ ìƒíƒœ í™•ì¸
            echo "=== Container Status ==="
            docker-compose ps
            
            # ë¡œê·¸ í™•ì¸
            echo "=== Backend Logs ==="
            docker-compose logs --tail=30 backend || true
            echo "=== Frontend Logs ==="
            docker-compose logs --tail=30 frontend || true
          EOF

      - name: Health Check
        run: |
          echo "ğŸ” ì„œë¹„ìŠ¤ ìƒíƒœ í™•ì¸ ì¤‘..."
          sleep 15
          
          # ë°±ì—”ë“œ í—¬ìŠ¤ ì²´í¬
          BACKEND_STATUS=$(curl -s -o /dev/null -w "%{http_code}" http://${{ secrets.EC2_HOST }}:8080/api/board || echo "000")
          echo "Backend Status: $BACKEND_STATUS"
          
          # í”„ë¡ íŠ¸ì—”ë“œ í—¬ìŠ¤ ì²´í¬
          FRONTEND_STATUS=$(curl -s -o /dev/null -w "%{http_code}" http://${{ secrets.EC2_HOST }}:3000 || echo "000")
          echo "Frontend Status: $FRONTEND_STATUS"
          
          if [ "$BACKEND_STATUS" = "200" ]; then
            echo "âœ… ë°±ì—”ë“œ ì„œë¹„ìŠ¤ ì •ìƒ"
          else
            echo "âš ï¸ ë°±ì—”ë“œ ì„œë¹„ìŠ¤ ì‘ë‹µ: $BACKEND_STATUS"
          fi
          
          if [ "$FRONTEND_STATUS" = "200" ]; then
            echo "âœ… í”„ë¡ íŠ¸ì—”ë“œ ì„œë¹„ìŠ¤ ì •ìƒ"
          else
            echo "âš ï¸ í”„ë¡ íŠ¸ì—”ë“œ ì„œë¹„ìŠ¤ ì‘ë‹µ: $FRONTEND_STATUS"
          fi

      - name: Cleanup
        if: always()
        run: |
          rm -f ~/.ssh/deploy_key
          rm -f /tmp/*.tar /tmp/*.tar.gz

